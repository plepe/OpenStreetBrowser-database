#!/usr/bin/php
<?
require "conf.php";
$modulekit_default_includes=array(
  "pgsql-functions"=>array("inc/*.sql"),
  "pgsql-init"=>array("init.sql"),
  "pgsql-after-import"=>array("after-import.sql"),
  "php"=>array("inc/*.php"),
);
require "modulekit/loader.php";
print_r($modulekit);

if(!function_exists("debug")) {
  define('D_ERROR', 3);
  define('D_WARNING', 2);
  define('D_NOTICE', 1);
  define('D_DEBUG', 0);

  function debug($msg, $module, $level=D_NOTICE) {
    print "DEBUG ($module, $level): $msg\n";
  }
}

if(!function_exists("sql_file")) {
  global $PG_PARAMS;
  $PG_PARAMS="-d {$db_central['name']}";
  $PG_PARAMS.=" --set ON_ERROR_STOP=1";

  function sql_file($file) {
    global $PG_PARAMS;

    debug("Executing $file", "openstreetbrowser-database", D_NOTICE);
    $ret=null;
    system("psql {$PG_PARAMS} -f '$file'", &$ret);

    if($ret!=0) {
      debug("An error occured executing $file", "openstreetbrowser-database", D_ERROR);
      exit;
    }
  }

  function sql_query($query) {
    $res=pg_query($query);
    if($res===false) {
      debug("An error occured: ".pg_last_error(), "openstreetbrowser-database", D_ERROR);
      exit;
    }

    return $res;
  }
}

// Connect to database
pg_connect("dbname={$db_central['name']} host={$db_central['host']} user={$db_central['name']} password={$db_central['passwd']}");

// Load extensions
sql_query("create extension hstore");
sql_query("create extension btree_gist");

// Load PostGIS functions
if(!isset($path_postgis))
  $path_postgis="/usr/share/postgresql/9.1/contrib/postgis-1.5";
sql_file("$path_postgis/postgis.sql");
sql_file("$path_postgis/spatial_ref_sys.sql");

// Load functions defined by modules
foreach(modulekit_get_includes("pgsql-functions") as $file) {
  sql_file($file);
}

// Initialize database modules
foreach(modulekit_get_includes("pgsql-init") as $file) {
  sql_file($file);
}

osm_import_db_init();

// Initialize database modules
foreach(modulekit_get_includes("pgsql-after-import") as $file) {
  sql_file($file);
}
